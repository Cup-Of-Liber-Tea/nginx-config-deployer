#!/bin/bash

# ==============================================================================
# Nginx μ„¤μ • μλ™ λ°±μ—… μ¤ν¬λ¦½νΈ (v1.0 - μΌλ°μ©)
#
# κΈ°λ¥:
# 1. /etc/nginx λ””λ ‰ν† λ¦¬ μ „μ²΄λ¥Ό νƒ€μ„μ¤νƒ¬ν”„κ°€ μ°ν .tar.gz μ••μ¶• νμΌλ΅ λ°±μ—…
# 2. μ§€μ •λ κΈ°κ°„μ΄ μ§€λ‚ μ¤λλ λ°±μ—… νμΌμ€ μλ™μΌλ΅ μ‚­μ 
# ==============================================================================

# μ¤ν¬λ¦½νΈλ” λ°λ“μ‹ sudo κ¶ν•μΌλ΅ μ‹¤ν–‰λμ–΄μ•Ό ν•©λ‹λ‹¤.
if [ "$EUID" -ne 0 ]; then
    echo "π¨ μ΄ μ¤ν¬λ¦½νΈλ” sudo κ¶ν•μΌλ΅ μ‹¤ν–‰ν•΄μ•Ό ν•©λ‹λ‹¤."
    echo "   μ: sudo ./backup_nginx_config.sh"
    exit 1
fi

# --- λ³€μ μ„¤μ • (!!! μ‚¬μ© μ „ μ΄ λ¶€λ¶„μ„ μμ‹ μ ν™κ²½μ— λ§κ² μμ •ν•μ„Έμ” !!!) ---
# λ°±μ—…μ„ μ €μ¥ν•  λ””λ ‰ν† λ¦¬ κ²½λ΅
BACKUP_DIR="/path/to/your/backup/location/"
# λ°±μ—… λ€μƒ λ””λ ‰ν† λ¦¬ (λ€λ¶€λ¶„μ μ‹μ¤ν…μ—μ„ μ΄ κ°’μ€ μμ •ν•  ν•„μ” μ—†μ)
NGINX_CONFIG_PATH="/etc/nginx"
# λ°±μ—… λ³΄κ΄€ κΈ°κ°„ (μΌ λ‹¨μ„, μ: 7μΌμ΄ μ§€λ‚ νμΌμ€ μ‚­μ )
RETENTION_DAYS=7

# ==============================================================================
# STEP 1: λ°±μ—… λ””λ ‰ν† λ¦¬ ν™•μΈ λ° μƒμ„±
# ==============================================================================
echo "π“‚ STEP 1: λ°±μ—… λ””λ ‰ν† λ¦¬λ¥Ό ν™•μΈν•©λ‹λ‹¤..."
echo "   - κ²½λ΅: ${BACKUP_DIR}"

mkdir -p "${BACKUP_DIR}"
if [ $? -ne 0 ]; then
    echo "β λ°±μ—… λ””λ ‰ν† λ¦¬ μƒμ„± μ‹¤ν¨. κ²½λ΅μ™€ κ¶ν•μ„ ν™•μΈν•μ„Έμ”."
    exit 1
fi

# ==============================================================================
# STEP 2: Nginx μ„¤μ • λ°±μ—… μ‹¤ν–‰
# ==============================================================================
# λ‚ μ§ λ° μ‹κ°„ ν•μ‹ μ§€μ • (μ: nginx_backup_20250826_183000.tar.gz)
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILENAME="nginx_backup_${DATE}.tar.gz"
BACKUP_FILE_PATH="${BACKUP_DIR}/${BACKUP_FILENAME}"

echo "π€ STEP 2: Nginx μ„¤μ • λ°±μ—…μ„ μ‹μ‘ν•©λ‹λ‹¤..."
echo "   - μ›λ³Έ: ${NGINX_CONFIG_PATH}"
echo "   - λ€μƒ νμΌ: ${BACKUP_FILE_PATH}"

# tar λ…λ Ήμ–΄λ΅ λ””λ ‰ν† λ¦¬λ¥Ό ν•λ‚μ μ••μ¶• νμΌλ΅ λ°±μ—…
# c: μƒλ΅μ΄ μ•„μΉ΄μ΄λΈ μƒμ„±, z: gzipμΌλ΅ μ••μ¶•, f: νμΌλ… μ§€μ •, p: κ¶ν• λ³΄μ΅΄
tar -czpf "${BACKUP_FILE_PATH}" -C "$(dirname "${NGINX_CONFIG_PATH}")" "$(basename "${NGINX_CONFIG_PATH}")"

if [ $? -ne 0 ]; then
    echo "β Nginx μ„¤μ • λ°±μ—… μ‹¤ν¨!"
    exit 1
fi

echo "   - λ°±μ—… νμΌ μƒμ„± μ™„λ£!"

# ==============================================================================
# STEP 3: μ¤λλ λ°±μ—… νμΌ μ •λ¦¬
# ==============================================================================
echo "π§Ή STEP 3: μ¤λλ λ°±μ—… νμΌ(${RETENTION_DAYS}μΌ κ²½κ³Ό)μ„ μ •λ¦¬ν•©λ‹λ‹¤..."

# find λ…λ Ήμ–΄λ΅ μ§€μ •λ κΈ°κ°„μ΄ μ§€λ‚ λ°±μ—… νμΌ κ²€μƒ‰ ν›„ μ‚­μ 
find "${BACKUP_DIR}" -type f -name "nginx_backup_*.tar.gz" -mtime +${RETENTION_DAYS} -exec echo "   - μ‚­μ : {}" \; -exec rm {} \;

echo "β…β¨ Nginx μ„¤μ • λ°±μ—…μ΄ μ„±κ³µμ μΌλ΅ μ™„λ£λμ—μµλ‹λ‹¤!"
