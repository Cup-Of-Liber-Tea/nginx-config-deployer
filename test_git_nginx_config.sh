#!/bin/bash

# ==============================================================================
# Nginx μ„¤μ • μ‚¬μ „ ν…μ¤νΈ μ¤ν¬λ¦½νΈ (v1.0 - μΌλ°μ©)
#
# κΈ°λ¥:
# 1. Git μ €μ¥μ†μ— μλ” Nginx μ„¤μ • νμΌμ λ¬Έλ²•μ„ ν…μ¤νΈν•©λ‹λ‹¤.
# 2. μ‹¤μ  μ΄μ μ¤‘μΈ /etc/nginx μ„λΉ„μ¤μ—λ” μ „ν€ μν–¥μ„ μ£Όμ§€ μ•μµλ‹λ‹¤.
# 3. λ°°ν¬ μ¤ν¬λ¦½νΈλ¥Ό μ‹¤ν–‰ν•κΈ° μ „, λ³€κ²½ μ‚¬ν•­μ„ λ―Έλ¦¬ κ²€μ¦ν•λ” μ©λ„μ…λ‹λ‹¤.
# ==============================================================================

# μ¤ν¬λ¦½νΈλ” λ°λ“μ‹ sudo κ¶ν•μΌλ΅ μ‹¤ν–‰λμ–΄μ•Ό ν•©λ‹λ‹¤.
# (SSL μΈμ¦μ„ λ“± root κ¶ν•μ΄ ν•„μ”ν• νμΌμ„ μ½κΈ° μ„ν•¨)
if [ "$EUID" -ne 0 ]; then
    echo "π¨ μ΄ μ¤ν¬λ¦½νΈλ” sudo κ¶ν•μΌλ΅ μ‹¤ν–‰ν•΄μ•Ό ν•©λ‹λ‹¤."
    echo "   μ: sudo ./test_nginx_config.sh"
    exit 1
fi

# --- λ³€μ μ„¤μ • (!!! μ‚¬μ© μ „ μ΄ λ¶€λ¶„μ„ μμ‹ μ ν™κ²½μ— λ§κ² μμ •ν•μ„Έμ” !!!) ---
# GitμΌλ΅ κ΄€λ¦¬ν•λ” Nginx μ„¤μ • νμΌμ΄ μλ” λ΅μ»¬ λ””λ ‰ν† λ¦¬ κ²½λ΅
CONFIG_SOURCE_DIR="/path/to/your/nginx-config-repo/"
# ν…μ¤νΈν•  λ©”μΈ μ„¤μ • νμΌλ…
NGINX_CONF_FILENAME="nginx.conf"
# ν…μ¤νΈ λ€μƒ νμΌμ μ „μ²΄ κ²½λ΅
CONFIG_SOURCE_PATH="${CONFIG_SOURCE_DIR}${NGINX_CONF_FILENAME}"

# ==============================================================================
# STEP 1: μ„¤μ • νμΌ μ΅΄μ¬ μ—¬λ¶€ ν™•μΈ
# ==============================================================================
echo "π” STEP 1: ν…μ¤νΈν•  μ„¤μ • νμΌμ„ ν™•μΈν•©λ‹λ‹¤..."
echo "   - λ€μƒ νμΌ: ${CONFIG_SOURCE_PATH}"

if [ ! -f "${CONFIG_SOURCE_PATH}" ]; then
    echo "β ν…μ¤νΈ λ€μƒ νμΌμ΄ μ—†μµλ‹λ‹¤. κ²½λ΅λ¥Ό ν™•μΈν•μ„Έμ”."
    exit 1
fi

# ==============================================================================
# STEP 2: Nginx μ„¤μ • κµ¬λ¬Έ μ‚¬μ „ ν…μ¤νΈ
# ==============================================================================
echo "π§ STEP 2: Nginx μ„¤μ • κµ¬λ¬Έ μ‚¬μ „ ν…μ¤νΈλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."

# -t μµμ…μΌλ΅ ν…μ¤νΈ, -c μµμ…μΌλ΅ μ‹¤μ  μ„λΉ„μ¤κ°€ μ•„λ‹ Git μ €μ¥μ†μ μ„¤μ • νμΌ μ§€μ •
nginx -t -c "${CONFIG_SOURCE_PATH}"

if [ $? -ne 0 ]; then
    echo "β Nginx μ„¤μ • ν…μ¤νΈ μ‹¤ν¨. Git μ €μ¥μ†μ νμΌμ„ μμ •ν•μ‹­μ‹μ¤."
    exit 1
fi

echo "β…β¨ Git μ €μ¥μ†μ Nginx μ„¤μ •μ΄ μ ν¨ν•©λ‹λ‹¤! μ΄μ  λ°°ν¬λ¥Ό μ§„ν–‰ν•  μ μμµλ‹λ‹¤."
